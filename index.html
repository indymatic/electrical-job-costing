<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ackme Estimator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #1A1A1A; /* Dark charcoal gray */
      color: #E5E5E5; /* Off-white text for readability */
      font-size: 16px;
    }
    .container {
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      max-width: 1000px;
      width: 100%;
      background: #2C2C2C; /* Slightly lighter dark gray */
      margin: 1rem;
      box-sizing: border-box;
      text-align: center;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .header i {
      margin-right: 0.5rem;
      color: #E82127; /* Logo red */
      font-size: 1.5rem;
    }
    h1, h2 {
      font-weight: 600;
      text-transform: uppercase;
      color: #E82127; /* Logo red for headers */
    }
    h1 {
      font-size: 1.5rem;
    }
    h2 {
      font-size: 1.1rem;
    }
    h3 {
      font-size: 1rem;
      margin-top: 1rem;
    }
    button {
      background: #E82127; /* Logo red */
      color: #FFFFFF;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
    }
    button:hover {
      background: #C71B22; /* Slightly darker red for hover */
    }
    button i {
      margin-right: 0.5rem;
    }
    input, select, textarea {
      border: 1px solid #3C3C3C; /* Adjusted to match new color scheme */
      border-radius: 8px;
      padding: 0.75rem;
      width: 100%;
      box-sizing: border-box;
      background: #3C3C3C; /* Medium dark gray */
      color: #E5E5E5; /* Off-white text */
      font-size: 1rem;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #E82127; /* Logo red */
      outline: none;
    }
    textarea {
      min-height: 100px;
    }
    .relative {
      position: relative;
    }
    .relative i {
      color: #999999; /* Softer gray for icons */
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
    }
    .relative input, .relative textarea {
      padding-left: 2.5rem;
    }
    .relative select {
      padding-left: 2.5rem;
    }
    .table-container {
      overflow-x: auto;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    table {
      border-radius: 8px;
      overflow: hidden;
      background: #2C2C2C; /* Match container background */
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto;
    }
    thead tr {
      background: #3C3C3C; /* Medium dark gray */
    }
    th, td {
      border: 1px solid #3C3C3C; /* Adjusted to match new color scheme */
      padding: 0.5rem;
      font-size: 0.9rem;
      text-align: left;
    }
    tbody tr:hover {
      background: #3C3C3C; /* Hover matches table header */
    }
    .store-search-section {
      margin: 1rem auto;
      padding: 1rem;
      background: #3C3C3C; /* Medium dark gray */
      border-radius: 8px;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
      max-width: 600px;
    }
    .store-search-section p {
      margin: 0.5rem 0;
      font-size: 1rem;
      color: #E5E5E5;
    }
    .store-link-button {
      display: inline-block;
      background: #E82127; /* Logo red */
      color: #FFFFFF;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    .store-link-button:hover {
      background: #C71B22; /* Slightly darker red for hover */
    }
    .text-gray-600 {
      color: #999999; /* Softer gray */
    }
    label {
      font-weight: 400;
      margin-bottom: 0.25rem;
      display: block;
      color: #999999; /* Softer gray */
      font-size: 0.9rem;
    }
    .space-y-4 > * + * {
      margin-top: 1rem;
    }
    .space-x-4 {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }
    .bg-gray-500 {
      background: #3C3C3C; /* Medium dark gray */
    }
    .bg-gray-500:hover {
      background: #4C4C4C; /* Slightly lighter for hover */
    }
    .bg-red-600 {
      background: #E82127; /* Logo red */
    }
    .bg-red-600:hover {
      background: #C71B22; /* Slightly darker red for hover */
    }
    .text-red-600 {
      color: #E82127; /* Logo red */
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
      justify-items: center;
    }
    .dashboard-card {
      padding: 0.75rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      background: #3C3C3C; /* Medium dark gray */
      text-align: center;
      width: 100%;
      max-width: 200px;
    }
    .dashboard-card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .dashboard-card p {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .footer-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.8rem;
    }
    .footer-text-powered {
      font-weight: 600;
      color: #E82127; /* Logo red */
    }
    .footer-text-ackme-ai {
      font-weight: 400;
      font-size: 0.7rem;
      color: #E5E5E5;
    }
    .footer-logo {
      height: 40px;
      margin-top: 0.5rem;
    }
    .suggestions {
      background: #3C3C3C; /* Medium dark gray */
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem auto;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
      max-width: 600px;
    }
    .suggestions p {
      margin: 0.5rem 0;
      font-size: 1rem;
      color: #E5E5E5;
    }
    .grid-cols-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      justify-items: center;
    }
    .grid-cols-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      justify-items: center;
    }
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
        margin: 0.5rem;
      }
      h1 {
        font-size: 1.25rem;
      }
      h2 {
        font-size: 1rem;
      }
      button {
        padding: 0.75rem;
        font-size: 0.9rem;
        width: 100%;
        max-width: none;
      }
      input, select, textarea {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
      .relative i {
        font-size: 0.9rem;
      }
      .grid-cols-2, .grid-cols-3 {
        grid-template-columns: 1fr;
      }
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .dashboard-card {
        padding: 0.5rem;
        max-width: 150px;
      }
      .dashboard-card h3 {
        font-size: 0.8rem;
      }
      .dashboard-card p {
        font-size: 1rem;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        min-width: 600px;
      }
      th, td {
        font-size: 0.8rem;
        padding: 0.4rem;
      }
      .space-x-4 {
        flex-direction: column;
        align-items: center;
      }
      .space-x-4 button {
        width: 100%;
        max-width: 200px;
      }
      .store-link-button {
        padding: 0.5rem;
        font-size: 0.9rem;
        margin: 0.2rem;
      }
    }
    @media (max-width: 480px) {
      .container {
        padding: 0.75rem;
      }
      h1 {
        font-size: 1rem;
      }
      h2 {
        font-size: 0.9rem;
      }
      button {
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      input, select, textarea {
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      .relative i {
        font-size: 0.8rem;
      }
      .dashboard-card h3 {
        font-size: 0.7rem;
      }
      .dashboard-card p {
        font-size: 0.9rem;
      }
      th, td {
        font-size: 0.7rem;
        padding: 0.3rem;
      }
      .store-link-button {
        padding: 0.4rem;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    function App() {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [showPassword, setShowPassword] = useState(false);
      const [isSigningUp, setIsSigningUp] = useState(false);
      const [message, setMessage] = useState('');
      const [jobs, setJobs] = useState([]);
      const [pendingJob, setPendingJob] = useState({
        jobName: '',
        createdBy: '',
        dateEntered: '',
        jobType: 'Residential'
      });
      const [selectedJobId, setSelectedJobId] = useState(null);
      const [costEstimates, setCostEstimates] = useState({});
      const [costEstimate, setCostEstimate] = useState({
        labor: { hours: "", pricePerHour: "", totalLaborCost: "" },
        materials: [],
        materialMarkup: "",
        taxRate: "",
        specialSections: [],
        totalCost: ""
      });
      const [newMaterial, setNewMaterial] = useState({ name: '', cost: '', quantity: '' });
      const [newCustomMaterial, setNewCustomMaterial] = useState({ name: '', cost: '' });
      const [newSpecialSection, setNewSpecialSection] = useState({ name: '', cost: '', description: '' });
      const [currentPage, setCurrentPage] = useState('login');
      const [isLoadingJob, setIsLoadingJob] = useState(false);
      const [materialType, setMaterialType] = useState('Residential');
      const [customMaterials, setCustomMaterials] = useState([]);
      const [isNavigating, setIsNavigating] = useState(false);
      const [storeSearchQuery, setStoreSearchQuery] = useState('');
      const [suggestedPrice, setSuggestedPrice] = useState(null);

      useEffect(() => {
        const cachedCustomMaterials = localStorage.getItem('customMaterials');
        if (cachedCustomMaterials) {
          const parsedCustomMaterials = JSON.parse(cachedCustomMaterials);
          setCustomMaterials(parsedCustomMaterials);
          console.log('Loaded custom materials from localStorage:', parsedCustomMaterials);
        } else {
          console.log('No custom materials found in localStorage.');
        }
      }, []);

      useEffect(() => {
        if (customMaterials.length > 0) {
          localStorage.setItem('customMaterials', JSON.stringify(customMaterials));
          console.log('Saved custom materials to localStorage:', customMaterials);
        }
      }, [customMaterials]);

      useEffect(() => {
        const cachedJobs = localStorage.getItem('cachedJobs');
        const cachedEstimates = localStorage.getItem('cachedCostEstimates');
        if (cachedJobs) {
          const parsedJobs = JSON.parse(cachedJobs);
          const validatedJobs = parsedJobs.map(job => ({
            ...job,
            jobType: job.jobType || 'Residential'
          }));
          console.log('Loaded jobs from localStorage:', validatedJobs);
          setJobs(validatedJobs);
        } else {
          console.log('No cached jobs found in localStorage.');
        }
        if (cachedEstimates) {
          setCostEstimates(JSON.parse(cachedEstimates));
          console.log('Loaded cost estimates from localStorage:', costEstimates);
        } else {
          console.log('No cached cost estimates found in localStorage.');
        }
      }, []);

      useEffect(() => {
        if (jobs.length > 0) {
          localStorage.setItem('cachedJobs', JSON.stringify(jobs));
          console.log('Saved jobs to localStorage:', jobs);
        }
        if (Object.keys(costEstimates).length > 0) {
          localStorage.setItem('cachedCostEstimates', JSON.stringify(costEstimates));
          console.log('Saved cost estimates to localStorage:', costEstimates);
        }
      }, [jobs, costEstimates]);

      useEffect(() => {
        if (currentPage === 'dashboard' || currentPage === 'login') {
          console.log('Clearing selectedJobId and resetting state for page:', currentPage);
          setSelectedJobId(null);
          setIsLoadingJob(false);
          setIsNavigating(false);
          setCostEstimate({
            labor: { hours: "", pricePerHour: "", totalLaborCost: "" },
            materials: [],
            materialMarkup: "",
            taxRate: "",
            specialSections: [],
            totalCost: ""
          });
          setStoreSearchQuery('');
          setSuggestedPrice(null);
        }
      }, [currentPage]);

      useEffect(() => {
        console.log('bs state updated:', jobs);
      }, [jobs]);

      useEffect(() => {
        if (selectedJobId && currentPage === 'estimate' && !isNavigating) {
          console.log('Attempting to load job with selectedJobId:', selectedJobId);
          console.log('Current jobs state:', jobs);
          const selectedJob = jobs.find(job => job._id === selectedJobId);
          if (!selectedJob) {
            console.log('Job not found for selectedJobId:', selectedJobId);
            setMessage('Oops! Job not found. Let’s go back to the dashboard.');
            setIsLoadingJob(false);
            setSelectedJobId(null);
            setCurrentPage('dashboard');
            return;
          }
          console.log('Found job:', selectedJob);
          setIsLoadingJob(true);
          fetchCostEstimate(selectedJobId).catch(error => {
            console.error("Error fetching cost estimate:", error);
            setMessage('Oops! Couldn’t load the estimate. Using cached data if available.');
          }).finally(() => {
            setIsLoadingJob(false);
          });
        }
      }, [selectedJobId, currentPage, isNavigating, jobs]);

      const residentialMaterials = [
        { name: "Romex 14/2 (per foot)" },
        { name: "Romex 12/2 (per foot)" },
        { name: "Junction Box (4x4)" },
        { name: "Decora Outlet (15A)" },
        { name: "Decora GFCI Outlet (15A)" },
        { name: "Decora Switch" },
        { name: "Dimmer Switch" },
        { name: "LED Recessed Light" },
        { name: "Ceiling Light Fixture" },
        { name: "Smoke Detector" }
      ];

      const commercialMaterials = [
        { name: "EMT Conduit 1\" (per foot)" },
        { name: "THHN Wire 10 AWG (per foot)" },
        { name: "Junction Box (6x6)" },
        { name: "Commercial Receptacle (20A)" },
        { name: "GFCI Receptacle (20A)" },
        { name: "Occupancy Sensor" },
        { name: "LED Panel Light (2x4)" },
        { name: "High Bay LED Light" },
        { name: "Exit Sign (LED)" },
        { name: "Fire Alarm Pull Station" }
      ];

      const availableMaterials = [
        ...(materialType === 'Residential' ? residentialMaterials : commercialMaterials),
        ...customMaterials
      ];

      useEffect(() => {
        if (isLoggedIn) {
          fetchJobs();
          fetchAllCostEstimates();
        }
      }, [isLoggedIn]);

      const fetchJobs = async () => {
        try {
          const response = await fetch('http://localhost:5000/api/jobs', { timeout: 5000 });
          if (!response.ok) throw new Error('Failed to fetch jobs');
          const data = await response.json();
          const validatedJobs = data.map(job => ({
            ...job,
            jobType: job.jobType || 'Residential'
          }));
          console.log('Fetched and validated jobs from server:', validatedJobs);
          setJobs(validatedJobs);
        } catch (error) {
          console.error('Error fetching jobs:', error);
          setMessage('Oops! Couldn’t load jobs from the server. Using cached data if available. Check if the backend server is running at http://localhost:5000.');
        }
      };

      const fetchAllCostEstimates = async () => {
        try {
          const response = await fetch('http://localhost:5000/api/cost-estimates', { timeout: 5000 });
          if (!response.ok) throw new Error('Failed to fetch cost estimates');
          const data = await response.json();
          const estimatesMap = {};
          data.forEach(estimate => {
            estimatesMap[estimate.jobId] = {
              totalCost: estimate.totalCost || "",
              labor: estimate.labor || { hours: "", pricePerHour: "", totalLaborCost: "" },
              materials: estimate.materials || [],
              materialMarkup: estimate.materialMarkup || "",
              taxRate: estimate.taxRate || "",
              specialSections: estimate.specialSections || []
            };
          });
          setCostEstimates(estimatesMap);
          console.log('Fetched cost estimates from server:', estimatesMap);
        } catch (error) {
          console.error('Error fetching cost estimates:', error);
          setMessage('Oops! Couldn’t load cost estimates from the server. Using cached data if available. Check if the backend server is running at http://localhost:5000.');
        }
      };

      const fetchCostEstimate = async (jobId) => {
        try {
          const response = await fetch(`http://localhost:5000/api/cost-estimates/${jobId}`, { timeout: 5000 });
          if (!response.ok) throw new Error('Failed to fetch cost estimate');
          const data = await response.json();
          if (data && Object.keys(data).length > 0) {
            setCostEstimate({
              ...data,
              labor: {
                hours: data.labor.hours || "",
                pricePerHour: data.labor.pricePerHour || "",
                totalLaborCost: data.labor.totalLaborCost || ""
              }
            });
            console.log('Fetched cost estimate for jobId:', jobId, data);
          } else {
            setCostEstimate({
              labor: { hours: "", pricePerHour: "", totalLaborCost: "" },
              materials: [],
              materialMarkup: "",
              taxRate: "",
              specialSections: [],
              totalCost: ""
            });
            console.log('No cost estimate found for jobId:', jobId, 'resetting to default');
          }
        } catch (error) {
          setCostEstimate({
            labor: { hours: "", pricePerHour: "", totalLaborCost: "" },
            materials: [],
            materialMarkup: "",
            taxRate: "",
            specialSections: [],
            totalCost: ""
          });
          console.error('Error fetching cost estimate for jobId:', jobId, error);
          throw error;
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          const response = await fetch('http://localhost:5000/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          const data = await response.json();
          setMessage(data.message);
          if (response.ok) {
            setIsLoggedIn(true);
            setUsername(data.username);
            setPendingJob(prev => ({ ...prev, createdBy: data.username }));
            setCurrentPage('dashboard');
            setSelectedJobId(null);
            setIsLoadingJob(false);
            setIsNavigating(false);
            console.log('Logged in successfully, navigating to dashboard. Username:', data.username);
          }
        } catch (error) {
          console.error('Error logging in:', error);
          if (error.name === 'AbortError') {
            setMessage('Oops! The server took too long to respond. Please check if the server is running at http://localhost:5000.');
          } else {
            setMessage('Oops! Something went wrong. Make sure the server is running at http://localhost:5000.');
          }
        }
      };

      const handleSignUp = async (e) => {
        e.preventDefault();
        if (password !== confirmPassword) {
          setMessage('Passwords do not match! Try again.');
          return;
        }
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          const response = await fetch('http://localhost:5000/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          const data = await response.text();
          setMessage(data);
          if (response.ok) {
            setIsSigningUp(false);
            console.log('Sign-up successful, switching to login page.');
          }
        } catch (error) {
          console.error('Error signing up:', error);
          if (error.name === 'AbortError') {
            setMessage('Oops! The server took too long to respond. Please check if the server is running at http://localhost:5000.');
          } else {
            setMessage('Oops! Something went wrong. Make sure the server is running at http://localhost:5000.');
          }
        }
      };

      const suggestPrice = (newJob) => {
        console.log('AI buddy is running suggestPrice for new job:', newJob);
        console.log('Current jobs in memory:', jobs);
        console.log('Current cost estimates in memory:', costEstimates);
        
        const pastJobs = jobs.filter(job => job.jobType === newJob.jobType && costEstimates[job._id]?.totalCost);
        console.log('Found past jobs of type', newJob.jobType, ':', pastJobs);

        if (pastJobs.length === 0) {
          console.log('No past jobs found for this job type. No suggestion possible.');
          return null;
        }

        let totalLaborHours = 0;
        let totalPricePerHour = 0;
        let totalMaterialCost = 0;
        let totalMaterialMarkup = 0;
        let totalTaxRate = 0;
        let totalSpecialCost = 0;
        let count = 0;

        pastJobs.forEach(job => {
          const estimate = costEstimates[job._id];
          if (estimate && estimate.totalCost) {
            const laborHours = parseFloat(estimate.labor.hours || 0);
            const pricePerHour = parseFloat(estimate.labor.pricePerHour || 0);
            const materialCost = estimate.materials.reduce((sum, item) => {
              const quantity = parseInt(item.quantity || 0);
              const costPerUnit = parseFloat(item.cost || 0);
              const adjustedMarkup = quantity > 10 ? 0.9 : 1; // 10% discount on markup for quantities over 10
              return sum + (costPerUnit * quantity * adjustedMarkup);
            }, 0);
            const materialMarkup = parseFloat(estimate.materialMarkup || 0);
            const taxRate = parseFloat(estimate.taxRate || 0);
            const specialCost = estimate.specialSections.reduce((sum, section) => sum + parseFloat(section.cost || 0), 0);

            totalLaborHours += laborHours;
            totalPricePerHour += pricePerHour;
            totalMaterialCost += materialCost;
            totalMaterialMarkup += materialMarkup;
            totalTaxRate += taxRate;
            totalSpecialCost += specialCost;
            count++;
          }
        });

        if (count === 0) {
          console.log('No valid data found in past jobs. No suggestion possible.');
          return null;
        }

        const avgLaborHours = totalLaborHours / count;
        const avgPricePerHour = totalPricePerHour / count;
        const avgLaborCost = avgLaborHours * avgPricePerHour;
        const avgMaterialCost = totalMaterialCost / count;
        const avgMaterialMarkup = totalMaterialMarkup / count;
        const avgTaxRate = totalTaxRate / count;
        const avgSpecialCost = totalSpecialCost / count;

        const materialsTotal = avgMaterialCost * (1 + avgMaterialMarkup / 100);
        const tax = materialsTotal * (avgTaxRate / 100);
        let suggestedCost = avgLaborCost + materialsTotal + tax + avgSpecialCost;

        let adjustment = 0;
        if (newJob.jobName.toLowerCase().includes('complex') || newJob.jobName.toLowerCase().includes('large')) {
          adjustment += suggestedCost * 0.2;
          console.log('Adding 20% adjustment for complex/large job:', adjustment);
        }
        if (newJob.jobName.toLowerCase().includes('outdoor')) {
          adjustment += suggestedCost * 0.1;
          console.log('Adding 10% adjustment for outdoor job:', adjustment);
        }

        const finalPrice = (suggestedCost + adjustment).toFixed(2);
        console.log('Final suggested price:', finalPrice);
        return finalPrice;
      };

      const handleCreateJob = async (e) => {
        e.preventDefault();
        console.log('handleCreateJob started with pendingJob:', pendingJob);
        
        setMessage('');
        if (!pendingJob.jobName) {
          console.log('Job name is missing!');
          setMessage('Please fill in the Job Name to create a job!');
          return;
        }

        console.log('Calling suggestPrice for AI buddy...');
        const suggested = suggestPrice(pendingJob);
        setSuggestedPrice(suggested);
        console.log('Suggested price set to:', suggested);

        setMessage(`Job added locally! ${suggested ? `Suggested price: $${suggested}` : 'No price suggestion yet.'} Trying to save it to the server...`);
        console.log('Message set:', suggested ? `Job added locally! Suggested price: $${suggested} Trying to save it to the server...` : 'Job added locally! No price suggestion yet. Trying to save it to the server...');

        const tempJobId = `temp_${Date.now()}`;
        const newJob = {
          _id: tempJobId,
          jobName: pendingJob.jobName,
          dateEntered: pendingJob.dateEntered || null,
          createdBy: pendingJob.createdBy || username || '',
          jobType: pendingJob.jobType
        };
        setJobs(prevJobs => {
          const updatedJobs = [...prevJobs, newJob];
          console.log('Added job locally with ID:', tempJobId, 'New jobs state:', updatedJobs);
          return updatedJobs;
        });
        setIsNavigating(true);

        let retries = 3;
        let success = false;
        let lastError = null;

        while (retries > 0 && !success) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            const response = await fetch('http://localhost:5000/api/jobs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                jobName: pendingJob.jobName,
                dateEntered: pendingJob.dateEntered || null,
                createdBy: pendingJob.createdBy || username || '',
                jobType: pendingJob.jobType
              }),
              signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) {
              const errorData = await response.text();
              throw new Error(errorData || `Failed to create job on server: ${response.status} ${response.statusText}`);
            }

            const savedJob = await response.json();
            console.log('Job saved to server with ID:', savedJob._id, 'Server response:', savedJob);

            setJobs(prevJobs => {
              const updatedJobs = prevJobs.map(job => job._id === tempJobId ? savedJob : job);
              console.log('Updated jobs state with server ID:', savedJob._id, 'New jobs state:', updatedJobs);
              return updatedJobs;
            });
            localStorage.setItem('cachedJobs', JSON.stringify(jobs.map(job => job._id === tempJobId ? savedJob : job)));
            setMessage(`Job created successfully! ${suggested ? `Suggested price: $${suggested}` : ''} Taking you to the job details... ⚡`);
            success = true;

            setTimeout(() => {
              setSelectedJobId(savedJob._id);
              setCurrentPage('estimate');
              setIsNavigating(false);
              setIsLoadingJob(true);
              console.log('Navigating to estimate page with selectedJobId:', savedJob._id);
            }, 0);
          } catch (error) {
            console.error(`Error creating job (attempt ${4 - retries}/3):`, error);
            lastError = error;
            retries--;
            if (retries > 0) {
              console.log(`Retrying... (${retries} attempts left)`);
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          }
        }

        if (!success) {
          console.error('All attempts to create job on server failed:', lastError);
          setMessage(`Oops! Couldn’t save job to server after multiple attempts: ${lastError.message}. Using local data with temp ID: ${tempJobId}.`);
          setTimeout(() => {
            setSelectedJobId(tempJobId);
            setCurrentPage('estimate');
            setIsNavigating(false);
            setIsLoadingJob(true);
            console.log('Navigating to estimate page with tempJobId:', tempJobId);
          }, 0);
        }

        setPendingJob({ jobName: '', createdBy: '', dateEntered: '', jobType: 'Residential' });
      };

      const handleDeleteJob = async (id) => {
        const job = jobs.find(job => job._id === id);
        const confirmDelete = window.confirm(`Are you sure you want to delete the job "${job.jobName}"?`);
        if (!confirmDelete) return;
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          const response = await fetch(`http://localhost:5000/api/jobs/${id}`, {
            method: 'DELETE',
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          if (!response.ok) throw new Error('Failed to delete job');
          setMessage('Job deleted successfully! ⚡');
          const updatedJobs = jobs.filter(job => job._id !== id);
          setJobs(updatedJobs);
          localStorage.setItem('cachedJobs', JSON.stringify(updatedJobs));
          await fetchJobs();
          await fetchAllCostEstimates();
          console.log('Job deleted successfully, ID:', id);
        } catch (error) {
          console.error('Error deleting job:', error);
          if (error.name === 'AbortError') {
            setMessage('Oops! The server took too long to respond. The job is deleted locally, but please check if the server is running at http://localhost:5000.');
          } else {
            setMessage('Oops! Something went wrong. Make sure the server is running at http://localhost:5000.');
          }
        }
      };

      const handleSaveEstimate = async (e) => {
        e.preventDefault();
        setMessage('');
        const job = jobs.find(job => job._id === selectedJobId);
        console.log("Job data when saving estimate:", job);
        if (!job || !job.jobName) {
          setMessage('Cannot create an estimate because the job name is missing! Please go back and create the job again.');
          return;
        }
        const hours = parseFloat(costEstimate.labor.hours || 0);
        const pricePerHour = parseFloat(costEstimate.labor.pricePerHour || 0);
        const totalLaborCost = hours * pricePerHour;
        let materialCost = costEstimate.materials.reduce((sum, item) => sum + (parseFloat(item.cost || 0) * parseInt(item.quantity || 0)), 0);
        const markup = materialCost * (parseFloat(costEstimate.materialMarkup || 0) / 100);
        const materialsTotal = materialCost + markup;
        const tax = materialsTotal * (parseFloat(costEstimate.taxRate || 0) / 100);
        const specialCost = costEstimate.specialSections.reduce((sum, section) => sum + parseFloat(section.cost || 0), 0);
        const subtotal = totalLaborCost + materialCost + markup + specialCost;
        const totalCost = subtotal + tax;

        console.log('Saving estimate locally first:', { totalCost });
        setCostEstimates(prevEstimates => {
          const newEstimates = {
            ...prevEstimates,
            [selectedJobId]: { 
              totalCost: totalCost.toFixed(2),
              labor: { ...costEstimate.labor, totalLaborCost },
              materials: costEstimate.materials,
              materialMarkup: costEstimate.materialMarkup,
              taxRate: costEstimate.taxRate,
              specialSections: costEstimate.specialSections
            }
          };
          console.log('Updated costEstimates state:', newEstimates);
          return newEstimates;
        });
        setCostEstimate(prevEstimate => {
          const newEstimate = { 
            ...prevEstimate, 
            totalCost: totalCost.toFixed(2)
          };
          console.log('Updated costEstimate state:', newEstimate);
          return newEstimate;
        });
        localStorage.setItem('cachedCostEstimates', JSON.stringify({
          ...costEstimates,
          [selectedJobId]: { 
            totalCost: totalCost.toFixed(2),
            labor: { ...costEstimate.labor, totalLaborCost },
            materials: costEstimate.materials,
            materialMarkup: costEstimate.materialMarkup,
            taxRate: costEstimate.taxRate,
            specialSections: costEstimate.specialSections
          }
        }));
        setMessage('Saving estimate...');

        let serverSuccess = false;
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          console.log('Attempting to save estimate to server...');
          const response = await fetch('http://localhost:5000/api/cost-estimates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jobId: selectedJobId,
              labor: { ...costEstimate.labor, totalLaborCost },
              materials: costEstimate.materials,
              materialMarkup: costEstimate.materialMarkup,
              taxRate: costEstimate.taxRate,
              specialSections: costEstimate.specialSections,
              totalCost
            }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to save cost estimate');
          }

          const savedEstimate = await response.json();
          console.log('Estimate saved to server for jobId:', selectedJobId, savedEstimate);
          serverSuccess = true;

          await fetchAllCostEstimates();

          setMessage('Estimate saved successfully! Returning to dashboard... ⚡');
          setTimeout(() => {
            setSelectedJobId(null);
            setCurrentPage('dashboard');
          }, 1000);
        } catch (error) {
          console.error('Error saving cost estimate to server for jobId:', selectedJobId, error);
          if (error.name === 'AbortError') {
            setMessage('Oops! The server took too long to respond. Estimate saved locally, but please check if the server is running at http://localhost:5000.');
          } else {
            setMessage(`Oops! Failed to save estimate to server: ${error.message}. Estimate saved locally, so your changes are safe!`);
          }
          setTimeout(() => {
            setSelectedJobId(null);
            setCurrentPage('dashboard');
          }, 1000);
        }
      };

      const handleAddMaterial = () => {
        if (!newMaterial.name || !newMaterial.cost || !newMaterial.quantity) {
          setMessage('Please fill in all material fields (name, cost, quantity)!');
          return;
        }
        setCostEstimate({
          ...costEstimate,
          materials: [...costEstimate.materials, { ...newMaterial }]
        });
        setNewMaterial({ name: '', cost: '', quantity: '' });
        setMessage('');
        console.log('Added material to estimate:', newMaterial);
      };

      const handleAddCustomMaterial = () => {
        if (!newCustomMaterial.name || !newCustomMaterial.cost) {
          setMessage('Please enter a material name and cost!');
          return;
        }
        const newCustomMat = { name: newCustomMaterial.name };
        setCustomMaterials(prev => {
          if (prev.some(mat => mat.name.toLowerCase() === newCustomMaterial.name.toLowerCase())) {
            return prev;
          }
          return [...prev, newCustomMat];
        });
        setCostEstimate({
          ...costEstimate,
          materials: [...costEstimate.materials, { name: newCustomMaterial.name, cost: newCustomMaterial.cost, quantity: '1' }]
        });
        setNewCustomMaterial({ name: '', cost: '' });
        setMessage('');
        console.log('Added custom material:', newCustomMaterial);
      };

      const handleAddSpecialSection = () => {
        if (!newSpecialSection.name || !newSpecialSection.cost) {
          setMessage('Please fill in the special section name and cost!');
          return;
        }
        setCostEstimate({
          ...costEstimate,
          specialSections: [...costEstimate.specialSections, newSpecialSection]
        });
        setNewSpecialSection({ name: '', cost: '', description: '' });
        setMessage('');
        console.log('Added special section:', newSpecialSection);
      };

      const generateStoreLink = (store, query) => {
        const encodedQuery = encodeURIComponent(query);
        switch (store) {
          case 'Home Depot':
            return `https://www.homedepot.com/s/${encodedQuery}`;
          case "Lowe's":
            return `https://www.lowes.com/search?searchTerm=${encodedQuery}`;
          case 'Menards':
            return `https://www.menards.com/main/search.html?searchTerm=${encodedQuery}`;
          case 'Grainger':
            return `https://www.grainger.com/search?searchQuery=${encodedQuery}`;
          default:
            return '#';
        }
      };

      if (currentPage === 'login') {
        return (
          <div className="container">
            <div className="header">
              <h1>Ackme Estimator</h1>
            </div>
            {isSigningUp ? (
              <form onSubmit={handleSignUp} className="space-y-4">
                <h2>Sign Up</h2>
                <div className="relative">
                  <i className="fas fa-user"></i>
                  <input
                    type="text"
                    placeholder="Username"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="p-2"
                  />
                </div>
                <div className="relative">
                  <i className="fas fa-lock"></i>
                  <input
                    type={showPassword ? "text" : "password"}
                    placeholder="Password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="p-2"
                  />
                </div>
                <div className="relative">
                  <i className="fas fa-lock"></i>
                  <input
                    type={showPassword ? "text" : "password"}
                    placeholder="Confirm Password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    className="p-2"
                  />
                </div>
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="w-full bg-gray-500"
                >
                  <i className={showPassword ? "fas fa-eye-slash" : "fas fa-eye"}></i>
                  {showPassword ? "Hide Password" : "Show Password"}
                </button>
                <button type="submit" className="w-full">
                  <i className="fas fa-user-plus"></i> Sign Up ⚡
                </button>
                <button
                  onClick={() => setIsSigningUp(false)}
                  className="w-full bg-gray-500"
                >
                  <i className="fas fa-arrow-left"></i> Back to Login
                </button>
                {message && <p className="text-center text-red-600">{message}</p>}
                <div className="footer-text">
                  <p className="footer-text-powered">Powered by The Ackme Co</p>
                  <p className="footer-text-ackme-ai">ACKME AI™</p>
                  <img src="https://i.ibb.co/SXchGTtJ/ackmelogo.jpg" alt="Ackme Co Logo" className="footer-logo" />
                </div>
              </form>
            ) : (
              <form onSubmit={handleLogin} className="space-y-4">
                <h2>Login</h2>
                <div className="relative">
                  <i className="fas fa-user"></i>
                  <input
                    type="text"
                    placeholder="Username"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="p-2"
                  />
                </div>
                <div className="relative">
                  <i className="fas fa-lock"></i>
                  <input
                    type={showPassword ? "text" : "password"}
                    placeholder="Password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="p-2"
                  />
                </div>
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="w-full bg-gray-500"
                >
                  <i className={showPassword ? "fas fa-eye-slash" : "fas fa-eye"}></i>
                  {showPassword ? "Hide Password" : "Show Password"}
                </button>
                <button type="submit" className="w-full">
                  <i className="fas fa-sign-in-alt"></i> Login ⚡
                </button>
                <button
                  onClick={() => setIsSigningUp(true)}
                  className="w-full"
                >
                  <i className="fas fa-user-plus"></i> Sign Up ⚡
                </button>
                {message && <p className="text-center text-red-600">{message}</p>}
                <div className="footer-text">
                  <p className="footer-text-powered">Powered by The Ackme Co</p>
                  <p className="footer-text-ackme-ai">ACKME AI™</p>
                  <img src="https://i.ibb.co/SXchGTtJ/ackmelogo.jpg" alt="Ackme Co Logo" className="footer-logo" />
                </div>
              </form>
            )}
          </div>
        );
      }

      if (currentPage === 'estimate' && selectedJobId) {
        const selectedJob = jobs.find(job => job._id === selectedJobId);
        if (isLoadingJob) {
          return (
            <div className="container">
              <p>Loading job details... ⏳</p>
            </div>
          );
        }
        if (!selectedJob) {
          return (
            <div className="container">
              <p>Job not found! Please go back to the dashboard.</p>
              <button
                onClick={() => {
                  setSelectedJobId(null);
                  setCurrentPage('dashboard');
                }}
                className="w-full mt-4"
              >
                <i className="fas fa-arrow-left"></i> Back to Dashboard ⚡
              </button>
            </div>
          );
        }

        const hours = parseFloat(costEstimate.labor.hours || 0);
        const pricePerHour = parseFloat(costEstimate.labor.pricePerHour || 0);
        const totalLaborCost = hours * pricePerHour;
        let materialCost = costEstimate.materials.reduce((sum, item) => sum + (parseFloat(item.cost || 0) * parseInt(item.quantity || 0)), 0);
        const markup = materialCost * (parseFloat(costEstimate.materialMarkup || 0) / 100);
        const materialsTotal = materialCost + markup;
        const tax = materialsTotal * (parseFloat(costEstimate.taxRate || 0) / 100);
        const specialCost = costEstimate.specialSections.reduce((sum, section) => sum + parseFloat(section.cost || 0), 0);
        const subtotal = totalLaborCost + materialCost + markup + specialCost;
        const totalCost = subtotal + tax;

        const suggested = suggestPrice(selectedJob);

        const exportToPDF = () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFillColor(232, 33, 39);
          doc.rect(0, 0, 210, 30, 'F');
          doc.setFontSize(20);
          doc.setTextColor(255, 255, 255);
          doc.text('Ackme Estimator', 20, 20);
          doc.setFontSize(14);
          doc.setTextColor(0, 0, 0);
          doc.text(`Estimate for ${selectedJob.jobName}`, 20, 40);
          doc.setFontSize(10);
          doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 50);
          doc.setFontSize(12);
          let y = 60;
          doc.text(`Labor Cost: $${totalLaborCost.toFixed(2)}`, 20, y);
          y += 10;
          doc.text(`Material Cost: $${materialCost.toFixed(2)}`, 20, y);
          y += 10;
          doc.text(`Material Markup: $${markup.toFixed(2)}`, 20, y);
          y += 10;
          doc.text(`Special Sections Cost: $${specialCost.toFixed(2)}`, 20, y);
          y += 10;
          doc.text(`Subtotal: $${subtotal.toFixed(2)}`, 20, y);
          y += 10;
          doc.text(`Tax (on Materials): $${tax.toFixed(2)}`, 20, y);
          y += 10;
          doc.text(`Estimated Total Cost: $${totalCost.toFixed(2)}`, 20, y);
          doc.save(`${selectedJob.jobName}_Estimate.pdf`);
          console.log('Exported PDF for job:', selectedJob.jobName);
        };

        return (
          <div className="container">
            <div className="header">
              <h1>Estimate & Tracker for {selectedJob.jobName}</h1>
            </div>
            <div className="space-x-4 mb-4">
              <button
                onClick={() => {
                  setSelectedJobId(null);
                  setCostEstimate({
                    labor: { hours: "", pricePerHour: "", totalLaborCost: "" },
                    materials: [],
                    materialMarkup: "",
                    taxRate: "",
                    specialSections: [],
                    totalCost: ""
                  });
                  setCurrentPage('dashboard');
                }}
              >
                <i className="fas fa-arrow-left"></i> Back to Dashboard ⚡
              </button>
              <button onClick={exportToPDF}>
                <i className="fas fa-file-pdf"></i> Export to PDF ⚡
              </button>
            </div>
            <form onSubmit={handleSaveEstimate} className="space-y-4">
              <div>
                <h2>Labor ⚡</h2>
                <div className="grid grid-cols-2 gap-4">
                  <div className="relative">
                    <i className="fas fa-clock"></i>
                    <label>Hours</label>
                    <input
                      type="number"
                      placeholder="Enter hours"
                      value={costEstimate.labor.hours}
                      onChange={(e) => setCostEstimate({
                        ...costEstimate,
                        labor: { ...costEstimate.labor, hours: e.target.value }
                      })}
                      className="p-2"
                    />
                  </div>
                  <div className="relative">
                    <i className="fas fa-dollar-sign"></i>
                    <label>Price per Hour ($)</label>
                    <input
                      type="number"
                      placeholder="Enter price per hour"
                      value={costEstimate.labor.pricePerHour}
                      onChange={(e) => setCostEstimate({
                        ...costEstimate,
                        labor: { ...costEstimate.labor, pricePerHour: e.target.value }
                      })}
                      className="p-2"
                    />
                  </div>
                  <div className="relative">
                    <i className="fas fa-calculator"></i>
                    <label>Total Labor Cost ($)</label>
                    <input
                      type="text"
                      value={totalLaborCost ? totalLaborCost.toFixed(2) : ""}
                      readOnly
                      className="p-2 bg-gray-500"
                    />
                  </div>
                </div>
              </div>
              <div>
                <h2>Materials ⚡</h2>
                <div className="mb-4">
                  <label>Material Type</label>
                  <div className="relative">
                    <i className="fas fa-tools"></i>
                    <select
                      value={materialType}
                      onChange={(e) => {
                        setMaterialType(e.target.value);
                        setCostEstimate({ ...costEstimate, materials: [] });
                      }}
                    >
                      <option value="Residential">Residential</option>
                      <option value="Commercial">Commercial</option>
                    </select>
                  </div>
                </div>
                <div className="grid grid-cols-3 gap-4">
                  <div className="relative">
                    <i className="fas fa-tools"></i>
                    <label>Material Name</label>
                    <select
                      value={newMaterial.name}
                      onChange={(e) => {
                        setNewMaterial({
                          ...newMaterial,
                          name: e.target.value
                        });
                      }}
                      className="p-2"
                    >
                      <option value="">Select Material</option>
                      {availableMaterials.map((mat, i) => (
                        <option key={i} value={mat.name}>{mat.name}</option>
                      ))}
                    </select>
                  </div>
                  <div className="relative">
                    <i className="fas fa-dollar-sign"></i>
                    <label>Price ($)</label>
                    <input
                      type="number"
                      placeholder="Enter price"
                      value={newMaterial.cost}
                      onChange={(e) => setNewMaterial({ ...newMaterial, cost: e.target.value })}
                      className="p-2"
                    />
                  </div>
                  <div className="relative">
                    <i className="fas fa-sort-numeric-up"></i>
                    <label>Quantity</label>
                    <input
                      type="number"
                      placeholder="Enter quantity"
                      value={newMaterial.quantity}
                      onChange={(e) => setNewMaterial({ ...newMaterial, quantity: e.target.value })}
                      className="p-2"
                    />
                  </div>
                </div>
                <button
                  type="button"
                  onClick={handleAddMaterial}
                  className="w-full mb-2 mt-2"
                >
                  <i className="fas fa-plus"></i> Add Material ⚡
                </button>
                <div className="mt-4">
                  <h3>Add Custom Material ⚡</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="relative">
                      <i className="fas fa-tools"></i>
                      <label>Material Name</label>
                      <input
                        type="text"
                        placeholder="Material Name"
                        value={newCustomMaterial.name}
                        onChange={(e) => setNewCustomMaterial({ ...newCustomMaterial, name: e.target.value })}
                        className="p-2"
                      />
                    </div>
                    <div className="relative">
                      <i className="fas fa-dollar-sign"></i>
                      <label>Cost ($)</label>
                      <input
                        type="number"
                        placeholder="Enter cost"
                        step="0.01"
                        value={newCustomMaterial.cost}
                        onChange={(e) => setNewCustomMaterial({ ...newCustomMaterial, cost: e.target.value })}
                        className="p-2"
                      />
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={handleAddCustomMaterial}
                    className="w-full mt-2"
                  >
                    <i className="fas fa-plus"></i> Add Custom Material ⚡
                  </button>
                </div>
                <div className="store-search-section">
                  <h3>Search for Items at Stores ⚡</h3>
                  <div className="relative">
                    <i className="fas fa-search"></i>
                    <input
                      type="text"
                      placeholder="Search for an item..."
                      value={storeSearchQuery}
                      onChange={(e) => setStoreSearchQuery(e.target.value)}
                      className="p-2 mb-2"
                    />
                  </div>
                  {storeSearchQuery ? (
                    <p>
                      Search for "{storeSearchQuery}" at: 
                      <a href={generateStoreLink('Home Depot', storeSearchQuery)} target="_blank" rel="noopener noreferrer" className="store-link-button">Home Depot</a>
                      <a href={generateStoreLink("Lowe's", storeSearchQuery)} target="_blank" rel="noopener noreferrer" className="store-link-button">Lowe's</a>
                      <a href={generateStoreLink('Menards', storeSearchQuery)} target="_blank" rel="noopener noreferrer" className="store-link-button">Menards</a>
                      <a href={generateStoreLink('Grainger', storeSearchQuery)} target="_blank" rel="noopener noreferrer" className="store-link-button">Grainger</a>
                    </p>
                  ) : (
                    <p>Enter an item to search for store links!</p>
                  )}
                </div>
                <div className="table-container">
                  <table className="w-full">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Cost ($)</th>
                        <th>Quantity</th>
                        <th>Total ($)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {costEstimate.materials.map((material, index) => (
                        <tr key={index}>
                          <td>{material.name}</td>
                          <td>{parseFloat(material.cost || 0).toFixed(2)}</td>
                          <td>{material.quantity}</td>
                          <td>{(parseFloat(material.cost || 0) * parseInt(material.quantity || 0)).toFixed(2)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
              <div>
                <h2>Material Markup (%) ⚡</h2>
                <div className="relative">
                  <i className="fas fa-percentage"></i>
                  <input
                    type="number"
                    placeholder="Enter markup percentage"
                    value={costEstimate.materialMarkup}
                    onChange={(e) => setCostEstimate({ ...costEstimate, materialMarkup: e.target.value })}
                    className="p-2"
                  />
                </div>
              </div>
              <div>
                <h2>Tax Rate (%) ⚡</h2>
                <div className="relative">
                  <i className="fas fa-percentage"></i>
                  <input
                    type="number"
                    placeholder="Enter tax rate (applied to materials only)"
                    value={costEstimate.taxRate}
                    onChange={(e) => setCostEstimate({ ...costEstimate, taxRate: e.target.value })}
                    className="p-2"
                  />
                </div>
              </div>
              <div>
                <h2>Special Sections ⚡</h2>
                <div className="relative">
                  <i className="fas fa-clipboard"></i>
                  <input
                    type="text"
                    placeholder="Section Name"
                    value={newSpecialSection.name}
                    onChange={(e) => setNewSpecialSection({ ...newSpecialSection, name: e.target.value })}
                    className="p-2 mb-2"
                  />
                </div>
                <div className="relative">
                  <i className="fas fa-dollar-sign"></i>
                  <input
                    type="number"
                    placeholder="Cost ($)"
                    value={newSpecialSection.cost}
                    onChange={(e) => setNewSpecialSection({ ...newSpecialSection, cost: e.target.value })}
                    className="p-2 mb-2"
                  />
                </div>
                <div className="relative">
                  <i className="fas fa-align-left"></i>
                  <textarea
                    placeholder="Description"
                    value={newSpecialSection.description}
                    onChange={(e) => setNewSpecialSection({ ...newSpecialSection, description: e.target.value })}
                    className="p-2 mb-2"
                  />
                </div>
                <button
                  type="button"
                  onClick={handleAddSpecialSection}
                  className="w-full"
                >
                  <i className="fas fa-plus"></i> Add Special Section ⚡
                </button>
                <div className="table-container">
                  <table className="w-full mt-2">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Cost ($)</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      {costEstimate.specialSections.map((section, index) => (
                        <tr key={index}>
                          <td>{section.name}</td>
                          <td>{parseFloat(section.cost || 0).toFixed(2)}</td>
                          <td>{section.description}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
              <div>
                <h2>Cost Breakdown ⚡</h2>
                <div className="table-container">
                  <table className="w-full">
                    <tbody>
                      <tr>
                        <td>Labor Cost</td>
                        <td>${totalLaborCost.toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>Material Cost</td>
                        <td>${materialCost.toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>Material Markup</td>
                        <td>${markup.toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>Special Sections Cost</td>
                        <td>${specialCost.toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>Subtotal</td>
                        <td>${subtotal.toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>Tax (on Materials)</td>
                        <td>${tax.toFixed(2)}</td>
                      </tr>
                      <tr>
                        <td>Estimated Total Cost</td>
                        <td>${totalCost.toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div>
                <h2>AI Suggested Cost ⚡</h2>
                <p>
                  {suggested 
                    ? `Suggested Total Cost for ${selectedJob.jobName}, ${selectedJob.jobType}, Entered on ${selectedJob.dateEntered || 'N/A'}: $${suggested}`
                    : 'No suggested cost available yet. Add more jobs to get AI suggestions!'}
                </p>
              </div>
              <button type="submit" className="w-full">
                <i className="fas fa-save"></i> Save Estimate ⚡
              </button>
              {message && <p className="text-center text-red-600 mt-2">{message}</p>}
            </form>
          </div>
        );
      }

      const activeJobs = jobs;
      const totalJobs = activeJobs.length;

      const currentDateTime = new Date().toLocaleString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true,
        timeZone: 'America/New_York'
      }) + ' EDT';

      return (
        <div className="container">
          <div className="header">
            <h1>Ackme Estimator</h1>
          </div>
          <div className="space-x-4 mb-4">
            <button
              onClick={() => {
                setCurrentPage('login');
                setSelectedJobId(null);
              }}
              className="bg-gray-500"
            >
              <i className="fas fa-sign-out-alt"></i> Logout ⚡
            </button>
          </div>
          <p>Welcome, {username}! ⚡</p>
          <p>Current Date and Time: {currentDateTime}</p>
          <div className="mb-4">
            <h2>Today's Weather for Central Indiana ⚡</h2>
            <p>Saturday, May 31, 2025: Low 80s, warm and muggy, possible showers ⛅</p>
            <p>Check more details on <a href="https://www.wunderground.com/weather/us/in/indianapolis" target="_blank" rel="noopener noreferrer" className="store-link-button">Weather Underground</a></p>
          </div>
          <div className="dashboard-grid">
            <div className="dashboard-card">
              <h3>Total Jobs</h3>
              <p>{totalJobs}</p>
            </div>
          </div>
          <div className="mb-4">
            <h2>Create New Job ⚡</h2>
            {message && <p className="text-center text-red-600 mb-4">{message}</p>}
            <form onSubmit={handleCreateJob} className="space-y-4">
              <div className="relative">
                <i className="fas fa-briefcase"></i>
                <input
                  type="text"
                  placeholder="Job Name"
                  value={pendingJob.jobName}
                  onChange={(e) => setPendingJob({ ...pendingJob, jobName: e.target.value })}
                  className="p-2"
                />
              </div>
              <div className="relative">
                <i className="fas fa-tools"></i>
                <label>Job Type</label>
                <select
                  value={pendingJob.jobType}
                  onChange={(e) => setPendingJob({ ...pendingJob, jobType: e.target.value })}
                  className="p-2"
                >
                  <option value="Residential">Residential</option>
                  <option value="Commercial">Commercial</option>
                </select>
              </div>
              <div className="relative">
                <i className="fas fa-user"></i>
                <label>Job Created By</label>
                <input
                  type="text"
                  placeholder="Your name (optional)"
                  value={pendingJob.createdBy}
                  onChange={(e) => setPendingJob({ ...pendingJob, createdBy: e.target.value })}
                  className="p-2"
                />
              </div>
              <div className="relative">
                <i className="fas fa-calendar-day"></i>
                <label>Date Entered</label>
                <input
                  type="date"
                  value={pendingJob.dateEntered}
                  onChange={(e) => setPendingJob({ ...pendingJob, dateEntered: e.target.value })}
                  className="p-2"
                />
              </div>
              <button type="submit" className="w-full">
                <i className="fas fa-plus"></i> Create Job ⚡
              </button>
            </form>
          </div>
          <h2>All Jobs ⚡</h2>
          <div className="table-container">
            <table className="w-full">
              <thead>
                <tr>
                  <th>Job Name</th>
                  <th>Created By</th>
                  <th>Estimated Total ($)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {activeJobs.length > 0 ? (
                  activeJobs.map(job => (
                    <tr key={job._id}>
                      <td>{job.jobName}</td>
                      <td>{job.createdBy || 'N/A'}</td>
                      <td>${parseFloat(costEstimates[job._id]?.totalCost || 0).toFixed(2)}</td>
                      <td className="space-x-4">
                        <button
                          onClick={() => {
                            setSelectedJobId(job._id);
                            setIsLoadingJob(true);
                            setCurrentPage('estimate');
                            setIsNavigating(false);
                            console.log('Navigating to estimate page for existing jobId:', job._id);
                          }}
                        >
                          <i className="fas fa-calculator"></i> Estimate ⚡
                        </button>
                        <button
                          onClick={() => handleDeleteJob(job._id)}
                          className="bg-red-600"
                        >
                          <i className="fas fa-trash"></i> Delete
                        </button>
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td colSpan="4" className="text-center">No jobs yet! Create one above! ⚡</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
    console.log('App rendered successfully.');
  </script>
</body>
</html>